# Intro

**로그인 처리를 어떻게 할지 정리해보는 중...**

<br><br>

# 로그인 처리

**로그인 처리 로직 - 세션 방식을 사용 (물론 전달을 해야해서 쿠키도 함께 사용)**

* 맨 처음에 로그인을 하면 서버에서 세션Id를 담은 쿠키를 클라에 응답으로 준다.
* 클라는 요청시 항상 쿠키에 세션Id가 포함되어 전달하게되고,  
  서버는 전달받은 쿠키 정보로 "세션 저장소"를 조회해서 회원임을 인증한다 => 메모리에 "세션 저장소"

<br><br>

## 클라이언트

* **클라 상에서 로그인 기록 있으면 "소셜 로그인" 화면 없이 그냥 바로 => 서버로 uid 전송**
  * API 주소는 "로그인" 주소를 준다.

* **클라 상에서 로그인 기록 없으면 "소셜 로그인" 화면 및 로그인 시도 => 이때, 서버로 uid 전송**
  * API 주소는 "회원가입" 주소를 준다.

* **클라 상에서 로그아웃을 요청하는 경우는 쿠키 정보가 있어서 바로 API 호출 및 "소셜 로그인" 화면으로 이동.**

  * 물론, 클라 상의 로그인 기록도 꼭 지워줘야 나중에 "회원가입"으로 잘 넘어감.

  * API 주소는 "로그아웃" 주소를 준다.

<br><br>

## 서버

* **로그인 API => 받은 uid로 회원판단 시도!! ("회원 저장소"에서 확인!!)**

  - **회원 일시**
  * UUID로 세션Id를 생성해서 "회원 저장소"에서 받은 회원정보(=memberA)와 함께 "세션 저장소"에 기록
  * 세션Id를 응답 쿠키로 전달


  - **회원 아닐시** 
    - 회원이 아니라고 클라에게 전송 (클라는 위 <클라>파트의 2번 카테고리를 행하면 됨)


* **회원가입 API => 받은 uid로 회원판단 시도!! ("회원 저장소"에서 확인!!)**

  - **첫 가입 회원**
  * uid, 기타정보 등등을 "회원 저장소"에 기록하고, UUID로 세션Id를 생성해서 회원정보(=memberA)와 함께 "세션 저장소"에 기록
  * 세션Id를 응답 쿠키로 전달


  - **이미 가입한 중복 회원**
    - 이미 회원이라고 클라에게 전송 (클라는 위 <클라>파트의 1번 카테고리를 행하면 됨)


* **로그아웃 API**
  - 쿠키 정보에 세션Id를 활용해서 해당 세션을 "세션 저장소"에서 제거


<br><br>

## 기대 효과

* **로그인 할때 이점 => "소셜 로그인"을 사용한 이점**
  * "소셜 로그인"을 통해서 회원 id,pw 등등 개인정보는 해당 "소셜 커뮤니티"와 주고 받기 때문에 개인정보 털릴 위험이 적어짐. 
  * "소셜 로그인"을 통해서 얻은 uid 값 또한 회원 id,pw 와는 관계없는 값을 주기 때문에 uid만을 우리 "서버"에 줘서 회원가입을 하면 개인정보 털릴 걱정이 없음.(즉, pw털릴 위험이 없음)
    * "uid가 털린것 vs id,pw 털린것" 을 비교해봐도 uid가 훨씬 안정적

* **로그인 이후의 이점 => "세션 방식"을 사용한 이점**
  * "회원 저장소" 와 "세션 저장소"를 함께 운영함으로써 회원 정보와는 전혀 관련없는 세션Id값(UUID)을 쿠키에 담아서 클라와 통신을 하기 때문에 개인정보 털릴 걱정이 없음.
  * 만료시간을 설정할 수 있기 때문에 쿠키가 탈취당해도 시간이 지나면 사용못하게 할 수 있다.
  * 세션Id를 서버에서 관리하므로 해킹이 의심된다면?? 서버에서 해당 세션을 강제로 제거할 수 있다.

<br><br>

## 기타

* **만료시간**
  * 보통은 그냥 만료시간=30분 정했으면 30분 뒤에 세션이 제거되지만,  
    스프링의 `HttpSession`은 클라->서버 요청의 제일 최신 시간을 이용해서 그시간 + 만료시간 을 계산해서 세션을 제거해준다.
  * 우리는 만료시간을 어떤 방식을 체택 해야할까??  
    웹의 경우 클라에서 웹을 종료했다고해서 알 수 있는 방법이 없다. 다른 방법이 있다고는 하는데, 잘 모르겠다.
  * 하지만 앱의 경우 안드로이드를 예로들자면 앱 종료때 onDestroy() 이벤트가 발생한다.  
    따라서 앱의 종료 이벤트때 서버에 세션Id를 제거해주는 "로그아웃 API" 를 호출 코드를 작성한다.

* **세션 체크하는 코드는 우리 앱에서는 모든 로직에서 다 필요하다.**
  * **따라서 "공통 관심사"로 두고 해결**해야하는데, 스프링의 AOP로도 해결이 가능하지만  
    "서블릿 필터 or 스프링 인터셉터"를 사용하는것을 추천한다.   
  * 왜냐하면 웹과 관련된 공통 관심사는 HTTP의 정보들도 필요한데, 이 정보도 "서블릿 필터 or 스프링 인터셉터"는 "HttpServletRequest"로 제공하기 때문이다.
  * 결론 : "스프링 인터셉터"가 더 편리,정교,다양한기능 을 제공해서 이 방식을 이용  
    * 사용법은 "HandlerInterceptor" 인터페이스를 구현하면 된다.
    * 동작 흐름 : WAS->필터->서블릿(Dispatcher Servlet)->스프링 인터셉터->컨트롤러
      * 따라서 컨트롤러 전에 로그인 인증해서 인증여부에따라 컨트롤러를 호출하거나 안하면 된다.
